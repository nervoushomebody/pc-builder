<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>VR PC Builder</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.4/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.1.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    <script src="https://gftruj.github.io/webzamples/aframe/controls/oculus-thumbstick-controls.js"></script>
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            width: 250px;
            z-index: 10000;
        }
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            z-index: 10000;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s;
        }
        .completion-message {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
    <a-scene physics="gravity: -1.5"> <!-- Зменшена гравітація -->
        <a-assets>
            <img id="ground" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
            <img id="sky" src="https://cdn.aframe.io/a-painter/images/sky.jpg">
            <a-asset-item id="case-model" src="models/case.glb"></a-asset-item>
            <a-asset-item id="motherboard-model" src="models/motherboard.glb"></a-asset-item>
            <a-asset-item id="cpu-model" src="models/cpu.glb"></a-asset-item>
            <a-asset-item id="ram-model" src="models/ram.glb"></a-asset-item>
            <a-asset-item id="gpu-model" src="models/gpu.glb"></a-asset-item>
            <a-asset-item id="psu-model" src="models/psu.glb"></a-asset-item>
            <a-asset-item id="ssd-model" src="models/ssd.glb"></a-asset-item>
            
            <a-mixin id="interactive"
                     hoverable grabbable draggable respawnable
                     super-hands="colliderEvent: collisions;
                                colliderEventProperty: els;
                                colliderEndEvent: collisions;
                                colliderEndEventProperty: clearedEls;">
            </a-mixin>

            <a-mixin id="physics-hands"
                     physics-collider phase-shift
                     collision-filter="collisionForces: false"
                     static-body="shape: sphere; sphereRadius: 0.02">
            </a-mixin>
        </a-assets>

        <a-sky src="#sky"></a-sky>
        <a-plane id="ground-plane" src="#ground" rotation="-90 0 0" width="20" height="20" static-body></a-plane>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="completion-message" id="completion-message">PC successfully assembled!</div>
        
        <a-entity id="pc-case-station" position="0 0.8 -1.5" pc-builder>
            <!-- Base platform -->
            <a-box position="0 -1 0" width="0.6" height="0.01" depth="0.7" color="#4d4d4d" static-body></a-box>
            
            <!-- PC Case -->
            <a-entity id="pc-case" static-body>
                <a-gltf-model src="#case-model" scale="0.4 0.4 0.4" position="0 0 0"></a-gltf-model>
            </a-entity>
            
            <!-- Components will be placed here automatically -->
            <a-entity id="components-container">
                <!-- Motherboard -->
                <a-entity id="motherboard" class="component" data-type="motherboard" 
                          position="0 0.1 0" rotation="0 0 0" scale="0.3 0.3 0.3"
                          side-description="description: Материнська плата - основна плата системи"
                          snap-zone="snapTo: 0 0.1 0; snapDistance: 0.15">
                    <a-gltf-model src="#motherboard-model"></a-gltf-model>
                </a-entity>
                
                <!-- CPU -->
                <a-entity id="cpu" class="component" data-type="cpu" 
                          position="0 0 0" rotation="0 0 0" scale="0.3 0.3 0.3"
                          side-description="description: Процесор - мозок комп'ютера"
                          snap-zone="snapTo: 0 0.15 0; snapDistance: 0.1">
                    <a-gltf-model src="#cpu-model"></a-gltf-model>
                </a-entity>
                
                <!-- RAM -->
                <a-entity id="ram" class="component" data-type="ram" 
                          position="0 0 0" rotation="0 0 0" scale="0.3 0.3 0.3"
                          side-description="description: Оперативна пам'ять - тимчасова пам'ять"
                          snap-zone="snapTo: 0 0.15 0.05; snapDistance: 0.1">
                    <a-gltf-model src="#ram-model"></a-gltf-model>
                </a-entity>
                
                <!-- GPU -->
                <a-entity id="gpu" class="component" data-type="gpu" 
                          position="0 0 0" rotation="0 0 0" scale="0.3 0.3 0.3"
                          side-description="description: Відеокарта - обробка графіки"
                          snap-zone="snapTo: 0 0.1 -0.1; snapDistance: 0.15">
                    <a-gltf-model src="#gpu-model"></a-gltf-model>
                </a-entity>
                
                <!-- PSU -->
                <a-entity id="psu" class="component" data-type="psu" 
                          position="-0 0 0" rotation="0 0 0" scale="0.3 0.3 0.3"
                          side-description="description: Блок живлення - джерело енергії"
                          snap-zone="snapTo: -0.2 0.1 0; snapDistance: 0.15">
                    <a-gltf-model src="#psu-model"></a-gltf-model>
                </a-entity>
                
                <!-- SSD -->
                <a-entity id="ssd" class="component" data-type="ssd" 
                          position="0 0 0" rotation="0 0 0" scale="0.3 0.3 0.3"
                          side-description="description: SSD - сховище даних"
                          snap-zone="snapTo: 0.15 0.1 0; snapDistance: 0.1">
                    <a-gltf-model src="#ssd-model"></a-gltf-model>
                </a-entity>
            </a-entity>
            
            <!-- Invisible platform -->
            <a-box position="0 0.25 0" width="0.8" height="0.05" depth="0.8" static-body visible="false"></a-box>
            
            <!-- Light inside the case -->
            <a-light type="point" color="#ffffff" intensity="0.7" position="0 0.3 0"></a-light>
        </a-entity>

        <!-- Lighting -->
        <a-light type="ambient" color="#505050" intensity="0.6"></a-light>
        <a-light type="directional" position="0 5 0" rotation="-90 0 0" intensity="0.8"></a-light>
        <a-light type="directional" position="0 3 3" rotation="-60 0 0" intensity="0.5"></a-light>
        <a-light type="point" color="#ffffff" intensity="0.6" position="0 2 0"></a-light>

        <a-entity id="rig">
            <a-camera id="camera" position="0 1.6 0" look-controls wasd-controls="fly: true">
                <a-cursor id="cursor" raycaster="objects: [mixin='interactive']"></a-cursor>
            </a-camera>
            <a-entity id="leftHand" 
                      mixin="physics-hands" 
                      hand-controls="hand: left"
                      laser-controls="hand: left"
                      teleport-controls="teleportOrigin: #camera; button: trigger; type: parabolic"
                      oculus-thumbstick-controls="fly: true">
            </a-entity>
            <a-entity id="rightHand" 
                      mixin="physics-hands" 
                      hand-controls="hand: right"
                      laser-controls="hand: right"
                      teleport-controls="teleportOrigin: #camera; button: trigger; type: parabolic">
            </a-entity>
        </a-entity>

        <script>
            // Progress tracking
            const progressFill = document.getElementById('progress-fill');
            const completionMessage = document.getElementById('completion-message');
            let installedComponents = 0;
            const totalComponents = 6;

            // Make components interactive and movable
            document.querySelector('a-scene').addEventListener('loaded', function() {
                const components = document.querySelectorAll('.component');
                components.forEach(comp => {
                    comp.setAttribute('mixin', 'interactive');
                    comp.setAttribute('dynamic-body', 'shape: box; mass: 0.5; linearDamping: 0.5; angularDamping: 0.7');
                });
            });

            // Snap zone component for easy placement
            AFRAME.registerComponent('snap-zone', {
                schema: {
                    snapTo: {type: 'vec3', default: {x: 0, y: 0, z: 0}},
                    snapDistance: {type: 'number', default: 0.2}
                },
                init: function() {
                    this.originalPos = new THREE.Vector3(
                        this.el.getAttribute('position').x,
                        this.el.getAttribute('position').y,
                        this.el.getAttribute('position').z
                    );
                },
                tick: function() {
                    if (this.el.is('grabbed') || this.el.classList.contains('installed')) return;
                    
                    const currentPos = this.el.object3D.position;
                    const distance = currentPos.distanceTo(this.originalPos);
                    
                    if (distance < this.data.snapDistance) {
                        this.el.setAttribute('position', this.data.snapTo);
                        this.el.body.velocity.set(0, 0, 0);
                        this.el.body.angularVelocity.set(0, 0, 0);
                    }
                }
            });

            // PC Builder component
            AFRAME.registerComponent('pc-builder', {
                init: function () {
                    this.installedComponents = new Set();
                    this.el.sceneEl.addEventListener('component-installed', this.updateProgress.bind(this));
                    
                    // Set up collision checking
                    this.tick = AFRAME.utils.throttleTick(this.checkComponents, 100, this);
                },

                checkComponents: function() {
                    const components = document.querySelectorAll('.component:not(.installed)');
                    
                    components.forEach(comp => {
                        if (comp.is('grabbed')) return;
                        
                        // Check if component is near its original position (inside case)
                        const currentPos = comp.object3D.position;
                        const originalPos = new THREE.Vector3();
                        comp.object3D.parent.worldToLocal(originalPos.copy(comp.object3D.getWorldPosition(new THREE.Vector3())));
                        
                        if (currentPos.distanceTo(originalPos) < 0.15) {
                            this.installComponent(comp);
                        }
                    });
                },
                
                installComponent: function(component) {
                    component.classList.add('installed');
                    component.removeAttribute('dynamic-body');
                    component.setAttribute('static-body', '');
                    
                    // Reset to original position/rotation
                    component.object3D.position.set(
                        component.getAttribute('position').x,
                        component.getAttribute('position').y,
                        component.getAttribute('position').z
                    );
                    component.object3D.rotation.set(0, 0, 0);
                    
                    this.installedComponents.add(component.id);
                    this.el.sceneEl.emit('component-installed');
                },

                updateProgress: function() {
                    installedComponents = this.installedComponents.size;
                    progressFill.style.width = `${(installedComponents / totalComponents) * 100}%`;

                    if (installedComponents >= totalComponents) {
                        setTimeout(() => {
                            completionMessage.style.display = 'block';
                        }, 1000);
                    }
                }
            });

            // Component description display
            AFRAME.registerComponent('side-description', {
                schema: {
                    description: {type: 'string'},
                    offset: {type: 'vec3'}
                },
                init: function() {
                    this.descriptionText = document.createElement('a-text');
                    this.descriptionText.setAttribute('value', this.data.description);
                    this.descriptionText.setAttribute('align', 'left');
                    this.descriptionText.setAttribute('position', '0.1 0.2 0');
                    this.descriptionText.setAttribute('width', '2');
                    this.descriptionText.setAttribute('look-at', '#camera');
                    this.descriptionText.setAttribute('visible', 'false');
                    this.el.appendChild(this.descriptionText);

                    this.el.addEventListener('grab-start', () => {
                        this.descriptionText.setAttribute('visible', 'true');
                    });
                    this.el.addEventListener('grab-end', () => {
                        this.descriptionText.setAttribute('visible', 'false');
                    });
                }
            });

            // Respawn components if they fall
            AFRAME.registerComponent('respawnable', {
                init: function() {
                    this.originalPosition = new THREE.Vector3(
                        this.el.getAttribute('position').x,
                        this.el.getAttribute('position').y,
                        this.el.getAttribute('position').z
                    );
                },
                tick: function() {
                    if (this.el.object3D.position.y < -5 && !this.el.is('grabbed')) {
                        this.resetEntity();
                    }
                },
                resetEntity: function() {
                    const el = this.el;
                    if (el.body) {
                        el.body.position.copy(this.originalPosition);
                        el.body.velocity.set(0, 0, 0);
                        el.body.angularVelocity.set(0, 0, 0);
                    } else {
                        el.object3D.position.copy(this.originalPosition);
                    }
                }
            });

            // Phase shift for better grabbing
            AFRAME.registerComponent('phase-shift', {
                init: function() {
                    this.el.addEventListener('grab-start', () => {
                        this.el.setAttribute('collision-filter', {collisionForces: false});
                        this.el.setAttribute('dynamic-body', 'mass: 0.1'); // Легше рухати при триманні
                    });
                    this.el.addEventListener('grab-end', () => {
                        this.el.setAttribute('collision-filter', {collisionForces: true});
                        this.el.setAttribute('dynamic-body', 'mass: 0.5');
                    });
                }
            });
            
            // Hover effects
            AFRAME.registerComponent('hoverable', {
                init: function() {
                    this.el.addEventListener('hover-start', (evt) => {
                        evt.target.querySelectorAll('a-gltf-model').forEach(model => {
                            model.setAttribute('material', 'color', '#ffff00');
                        });
                    });
                    this.el.addEventListener('hover-end', (evt) => {
                        if (!this.el.is('grabbed')) {
                            evt.target.querySelectorAll('a-gltf-model').forEach(model => {
                                model.removeAttribute('material');
                            });
                        }
                    });
                    this.el.addEventListener('grab-start', (evt) => {
                        evt.target.querySelectorAll('a-gltf-model').forEach(model => {
                            model.setAttribute('material', 'color', '#ff0000');
                        });
                    });
                    this.el.addEventListener('grab-end', (evt) => {
                        evt.target.querySelectorAll('a-gltf-model').forEach(model => {
                            model.removeAttribute('material');
                        });
                    });
                }
            });
        </script>
    </a-scene>

    <div class="info">
        <strong>Керування:</strong><br>
        Корпус ПК перед вами. Компоненти розміщені всередині.<br><br>
        <strong>VR:</strong><br>
         - <strong>Брати:</strong> Протягніть руку та натисніть Trigger/Grip.<br>
         - <strong>Літати/Рухатись:</strong> Лівий джойстик для плавного руху.<br>
         - <strong>Телепортація:</strong> Натисніть trigger на контролері.<br>
         - <strong>Обертання:</strong> Правий джойстик.<br>
         - <strong>Інформація:</strong> Опис з'являється при триманні компонента.<br><br>
        <strong>Десктоп:</strong> WASD для руху, миша для огляду.
        <br><br>
        <strong>Мета:</strong> Виймайте та встановлюйте компоненти ПК назад!
    </div>
</body>
</html>
