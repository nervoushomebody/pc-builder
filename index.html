<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>VR Збирач ПК - Виправлена версія</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.4/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.1.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            width: 250px;
            z-index: 10000;
        }
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            z-index: 10000;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s;
        }
        .completion-message {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
    <a-scene physics="gravity: -9.8; friction: 0.1; restitution: 0.2;" renderer="colorManagement: true;">
        <a-assets>
            <img id="ground" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
            <img id="sky" src="https://cdn.aframe.io/a-painter/images/sky.jpg">
            <a-asset-item id="case-model" src="models/case.glb"></a-asset-item>
            <a-asset-item id="motherboard-model" src="models/motherboard.glb"></a-asset-item>
            <a-asset-item id="cpu-model" src="models/cpu.glb"></a-asset-item>
            <a-asset-item id="ram-model" src="models/ram.glb"></a-asset-item>
            <a-asset-item id="gpu-model" src="models/gpu.glb"></a-asset-item>
            <a-asset-item id="psu-model" src="models/psu.glb"></a-asset-item>
            <a-asset-item id="ssd-model" src="models/ssd.glb"></a-asset-item>
            
            <a-mixin id="interactive"
                     hoverable grabbable draggable respawnable
                     event-set__hoveron="_event: hover-start; attribute: material.emissive; value: #ffff00"
                     event-set__hoveroff="_event: hover-end; attribute: material.emissive; value: #000000"
                     event-set__grabon="_event: grab-start; attribute: material.emissive; value: #ff0000"
                     event-set__graboff="_event: grab-end; attribute: material.emissive; value: #ffff00">
            </a-mixin>

        </a-assets>

        <a-sky src="#sky"></a-sky>
        <a-plane id="ground-plane" src="#ground" rotation="-90 0 0" width="20" height="20" static-body></a-plane>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="completion-message" id="completion-message">ПК успішно зібрано!</div>
        
        <a-entity id="pc-case-station" position="0 0.8 -1.5"
                  snap-handler="partTypes: motherboard, psu, ssd;">
            <a-entity gltf-model="#case-model" scale="0.5 0.5 0.5" static-body></a-entity>
            
            <a-entity class="slot" data-part="motherboard" position="0.01 0.28 0" visible="false">
                 <a-box color="green" scale="0.3 0.01 0.35" wireframe="true"></a-box>
            </a-entity>
            <a-entity class="slot" data-part="psu" position="0 0.08 -0.2" visible="false">
                <a-box color="green" scale="0.15 0.08 0.15" wireframe="true"></a-box>
            </a-entity>
            <a-entity class="slot" data-part="ssd" position="0.15 0.15 0.15" visible="false">
                <a-box color="green" scale="0.1 0.01 0.07" wireframe="true"></a-box>
            </a-entity>
        </a-entity>

        <a-entity id="motherboard" dynamic-body="shape: box; mass: 2" position="-0.5 1.2 -1"
                  snap-handler="partTypes: cpu, ram, gpu;" data-part="motherboard">
            <a-gltf-model src="#motherboard-model" scale="0.25 0.25 0.25"></a-gltf-model>
             <a-entity class="slot" data-part="cpu" position="0.045 0.01 -0.01" visible="false">
                <a-box color="yellow" scale="0.04 0.01 0.04" wireframe="true"></a-box>
             </a-entity>
             <a-entity class="slot" data-part="ram" position="0.045 0.01 0.06" visible="false">
                 <a-box color="yellow" scale="0.01 0.03 0.08" wireframe="true"></a-box>
             </a-entity>
             <a-entity class="slot" data-part="gpu" position="-0.04 0.015 -0.08" visible="false">
                 <a-box color="yellow" scale="0.12 0.04 0.2" wireframe="true"></a-box>
             </a-entity>
        </a-entity>
        
        <a-entity id="cpu" mixin="interactive" dynamic-body="shape: box; mass: 0.2" position="-0.8 1.2 -1.5" data-part="cpu">
            <a-gltf-model src="#cpu-model" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-entity id="ram" mixin="interactive" dynamic-body="shape: box; mass: 0.3" position="-0.6 1.2 -1.5" data-part="ram">
            <a-gltf-model src="#ram-model" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>
        
        <a-entity id="gpu" mixin="interactive" dynamic-body="shape: box; mass: 1.5" position="-0.2 1.2 -1.5" data-part="gpu">
            <a-gltf-model src="#gpu-model" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-entity id="psu" mixin="interactive" dynamic-body="shape: box; mass: 2.5" position="0.2 1.2 -1.5" data-part="psu">
            <a-gltf-model src="#psu-model" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-entity id="ssd" mixin="interactive" dynamic-body="shape: box; mass: 0.4" position="0.5 1.2 -1.5" data-part="ssd">
            <a-gltf-model src="#ssd-model" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-light type="ambient" color="#888"></a-light>
        <a-light type="directional" position="-1 4 2" intensity="1"></a-light>

        <a-entity id="rig" movement-controls="fly: false; speed: 0.2">
            <a-entity camera position="0 1.6 0" look-controls></a-entity>
            <a-entity id="leftHand" super-hands hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"></a-entity>
            <a-entity id="rightHand" super-hands hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc"></a-entity>
        </a-entity>

        <script>
            // Глобальний стан збірки
            const progressFill = document.getElementById('progress-fill');
            const completionMessage = document.getElementById('completion-message');
            const totalComponents = 6;
            let installedCount = 0;

            function updateProgress() {
                installedCount++;
                const progress = (installedCount / totalComponents) * 100;
                progressFill.style.width = `${progress}%`;

                if (installedCount >= totalComponents) {
                    setTimeout(() => {
                        completionMessage.style.display = 'block';
                    }, 500);
                }
            }

            // Універсальний компонент для "примагнічування"
            AFRAME.registerComponent('snap-handler', {
                schema: {
                    partTypes: { type: 'array' }, // Які частини приймає цей об'єкт (напр. motherboard, cpu)
                    snapDistance: { type: 'number', default: 0.15 } // Відстань спрацювання
                },

                init: function () {
                    this.slots = {};
                    this.el.querySelectorAll('.slot').forEach(slotEl => {
                        const partType = slotEl.dataset.part;
                        if (this.data.partTypes.includes(partType)) {
                            this.slots[partType] = {
                                el: slotEl,
                                worldPos: new THREE.Vector3(),
                                isOccupied: false
                            };
                        }
                    });
                    this.partsToCheck = [];
                    this.el.sceneEl.addEventListener('loaded', () => {
                        this.data.partTypes.forEach(partType => {
                           const partEl = document.getElementById(partType);
                           if(partEl) this.partsToCheck.push(partEl);
                        });
                    });

                    // Зберігаємо початкові позиції для респауну
                    this.el.sceneEl.querySelectorAll('[data-part]').forEach(el => {
                        el.initialPosition = el.object3D.position.clone();
                    });
                },

                tick: function (time, timeDelta) {
                    // Оновлюємо позиції слотів щосекунди (оптимізація)
                    if (time % 1000 < timeDelta) {
                       for (const partType in this.slots) {
                           if (this.slots.hasOwnProperty(partType)) {
                               this.slots[partType].el.object3D.getWorldPosition(this.slots[partType].worldPos);
                           }
                       }
                    }

                    this.checkParts();
                },

                checkParts: function() {
                    this.partsToCheck.forEach(partEl => {
                        // Ігноруємо, якщо частина вже встановлена або її тримають
                        if (partEl.isInstalled || partEl.is('grabbed')) return;

                        const partType = partEl.dataset.part;
                        const slot = this.slots[partType];

                        // Перевіряємо, чи є відповідний вільний слот
                        if (slot && !slot.isOccupied) {
                            const partPos = partEl.object3D.position;
                            const distance = partPos.distanceTo(slot.worldPos);
                            
                            if (distance < this.data.snapDistance) {
                                this.installPart(partEl, slot);
                            }
                        }

                        // Респаун, якщо впало
                        if(partEl.object3D.position.y < -2) {
                             this.resetPart(partEl);
                        }
                    });
                },

                installPart: function(partEl, slot) {
                    partEl.isInstalled = true; // Ставимо прапорець, що частина встановлена
                    slot.isOccupied = true;
                    
                    // Вимикаємо фізику
                    partEl.removeAttribute('dynamic-body');

                    // Приєднуємо частину до слота. Це найважливіший крок!
                    // Тепер позиція частини буде відносною до її нового батька (слота).
                    slot.el.object3D.attach(partEl.object3D);

                    // Скидаємо локальну позицію та орієнтацію, щоб вона ідеально стала в слот
                    partEl.object3D.position.set(0, 0, 0);
                    partEl.object3D.rotation.set(0, 0, 0);

                    // Робимо частину неінтерактивною
                    partEl.removeAttribute('super-hands');
                    partEl.removeAttribute('mixin');


                    // Оновлюємо прогрес
                    updateProgress();
                    console.log(`Installed ${partEl.id} into ${this.el.id}`);
                },
                 
                resetPart: function(partEl) {
                    if (partEl.body) {
                        partEl.body.velocity.set(0, 0, 0);
                        partEl.body.angularVelocity.set(0, 0, 0);
                        partEl.body.position.copy(partEl.initialPosition);
                    }
                     partEl.object3D.position.copy(partEl.initialPosition);
                }
            });

        </script>
    </a-scene>

    <div class="info">
        <strong>Керування:</strong><br>
        Наведіть руку на компонент, щоб підсвітити, і стисніть контролер (Grip/Trigger), щоб взяти. Піднесіть компонент до відповідного місця (спочатку на материнську плату, потім в корпус), і він автоматично стане на місце.<br><br>
        <strong>Мета:</strong> Зібрати ПК, встановлюючи компоненти в правильному порядку!
    </div>
</body>
</html>
