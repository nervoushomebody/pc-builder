<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VR PC Builder - Simple Grab</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://unpkg.com/super-hands@^3.0.5/dist/super-hands.min.js"></script>
    <style>
        .debug-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            font-size: 14px;
            z-index: 10000;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="debug-info" id="debug-info">Status: Ready</div>

    <a-scene background="color: #1a1a2e">
        <a-assets>
            </a-assets>

        <a-sky color="#252535"></a-sky>
        <a-plane position="0 0 -4" rotation="-90 0 0" width="10" height="10" color="#3f3f5a"></a-plane>
        <a-light type="ambient" color="#888"></a-light>
        <a-light type="directional" intensity="0.5" position="-1 1 2"></a-light>

        <a-box id="pc-case" 
               position="0 1 -4" 
               width="0.6" height="0.8" depth="0.6" 
               color="#1a1a1a"
               opacity="0.9">
            <a-text value="PC CASE" position="0 0.5 0.31" align="center" color="#FFF"></a-text>
        </a-box>

        <a-entity id="motherboard" 
                  position="-1 1.2 -3" 
                  simple-grab
                  installable-item="target: #pc-case;"
                  geometry="primitive: box; width: 0.4; height: 0.02; depth: 0.4" 
                  material="color: #2a7f2a; metalness: 0.6">
            <a-text value="Motherboard" position="0 0.1 0" align="center" scale="0.3 0.3 0.3"></a-text>
            <a-box class="outline"
                   width="0.42" height="0.04" depth="0.42"
                   material="color: #00ff00; shader: flat; wireframe: true"
                   visible="false">
            </a-box>
        </a-entity>

        <a-entity id="rig" position="0 0 0" thumbstick-movement>
            <a-camera position="0 1.6 0" look-controls="pointerLockEnabled: true"></a-camera>

            <a-entity oculus-touch-controls="hand: left"></a-entity>
            <a-entity id="rightHand"
                      oculus-touch-controls="hand: right"
                      sphere-collider="objects: [simple-grab]"
                      super-hands="
                        grabStartButtons: gripdown;
                        grabEndButtons: gripup;
                        dragDropStartButtons: none; 
                        dragDropEndButtons: none;">
            </a-entity>
        </a-entity>
        
        <script>
            const debugInfo = document.getElementById('debug-info');

            /**
             * 1. THUMBSTICK MOVEMENT
             * Moves the player rig using the left thumbstick.
             */
            AFRAME.registerComponent('thumbstick-movement', {
                init: function () {
                    this.velocity = new THREE.Vector3();
                    this.el.sceneEl.addEventListener('thumbstickmoved', this.onThumbstickMoved.bind(this));
                },
                onThumbstickMoved: function (evt) {
                    // Use the left thumbstick for movement
                    if (evt.detail.hand === 'left') {
                        const rig = this.el;
                        const camera = rig.querySelector('[camera]');
                        const cameraRotation = camera.object3D.rotation.y;
                        const speed = 0.08;
                        const moveX = evt.detail.x * speed;
                        const moveZ = evt.detail.y * speed;

                        this.velocity.z = Math.cos(cameraRotation) * moveZ - Math.sin(cameraRotation) * moveX;
                        this.velocity.x = Math.sin(cameraRotation) * moveZ + Math.cos(cameraRotation) * moveX;
                    }
                },
                tick: function () {
                    if (this.velocity.lengthSq() > 0.0001) {
                        this.el.object3D.position.add(this.velocity);
                    }
                    this.velocity.multiplyScalar(0.8); // Apply friction
                }
            });

            /**
             * 2. SIMPLE GRAB
             * Attaches an entity to the controller on grab and handles release logic.
             */
            AFRAME.registerComponent('simple-grab', {
                init: function () {
                    this.outline = this.el.querySelector('.outline');
                    this.originalParent = this.el.parentNode; // The <a-scene>

                    this.onGrabStart = this.onGrabStart.bind(this);
                    this.onGrabEnd = this.onGrabEnd.bind(this);
                    
                    this.el.addEventListener('grab-start', this.onGrabStart);
                    this.el.addEventListener('grab-end', this.onGrabEnd);
                },

                onGrabStart: function (evt) {
                    const hand = evt.detail.hand;
                    hand.object3D.add(this.el.object3D); // Attach object to hand
                    if (this.outline) this.outline.setAttribute('visible', true); // Show outline
                    debugInfo.innerText = "Status: Grabbing Motherboard";
                },

                onGrabEnd: function (evt) {
                    if (this.outline) this.outline.setAttribute('visible', false); // Hide outline
                    
                    // Check if we should install the component
                    const installable = this.el.components['installable-item'];
                    if (installable && installable.checkAndInstall()) {
                        // The item was installed, so we don't need to do anything else.
                        debugInfo.innerText = "Status: Motherboard Installed!";
                    } else {
                        // The item was not installed, so drop it back into the scene.
                        const worldPos = new THREE.Vector3();
                        const worldRot = new THREE.Quaternion();
                        this.el.object3D.getWorldPosition(worldPos);
                        this.el.object3D.getWorldQuaternion(worldRot);

                        this.originalParent.object3D.add(this.el.object3D);
                        this.el.object3D.position.copy(worldPos);
                        this.el.object3D.quaternion.copy(worldRot);
                        debugInfo.innerText = "Status: Ready";
                    }
                },

                remove: function() {
                    this.el.removeEventListener('grab-start', this.onGrabStart);
                    this.el.removeEventListener('grab-end', this.onGrabEnd);
                }
            });

            /**
             * 3. INSTALLABLE ITEM
             * Manages the logic for an item that can be placed into a target.
             */
            AFRAME.registerComponent('installable-item', {
                schema: {
                    target: {type: 'selector'},
                    snapDistance: {type: 'number', default: 0.5} // How close to be to snap (in meters)
                },

                init: function() {
                    this.isInstalled = false;
                },

                checkAndInstall: function() {
                    if (this.isInstalled || !this.data.target) return false;

                    const elPos = new THREE.Vector3();
                    const targetPos = new THREE.Vector3();
                    this.el.object3D.getWorldPosition(elPos);
                    this.data.target.object3D.getWorldPosition(targetPos);
                    
                    const distance = elPos.distanceTo(targetPos);

                    if (distance < this.data.snapDistance) {
                        this.install();
                        return true;
                    }
                    return false;
                },
                
                install: function() {
                    this.isInstalled = true;
                    
                    // Attach to target and center it
                    this.data.target.object3D.add(this.el.object3D);
                    this.el.object3D.position.set(0, 0, 0); // Center in parent
                    this.el.object3D.rotation.set(0, 0, 0); // Align with parent

                    // Make it ungrabbable
                    this.el.removeAttribute('simple-grab');
                }
            });
        </script>
    </a-scene>
</body>
</html>
