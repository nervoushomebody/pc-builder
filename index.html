<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>VR PC Builder - Fixed Collisions</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.4/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://gftruj.github.io/webzamples/aframe/controls/oculus-thumbstick-controls.js"></script>
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            width: 300px;
            z-index: 10000;
        }
        .hand-coords {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            z-index: 10000;
        }
        .physics-debug {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #ffff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 10000;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="hand-coords" id="hand-coords">
        Left Hand: x: 0.00, y: 0.00, z: 0.00<br>
        Right Hand: x: 0.00, y: 0.00, z: 0.00
    </div>
    
    <div class="physics-debug" id="physics-debug">
        Physics Debug Info:<br>
        Gravity: -9.8<br>
        Selected Object: None
    </div>

    <a-scene physics="driver: local; debug: false; gravity: -9.8; iterations: 10">
        <a-assets>
            <!-- Define reusable mixins for physics objects -->
            <a-mixin id="cube-physics"
                     dynamic-body="linearDamping: 0.4; angularDamping: 0.6"
                     hoverable grabbable stretchable draggable
                     smooth-grabbing
                     event-set__hoveron="_event: hover-start; material.opacity: 0.7"
                     event-set__hoveroff="_event: hover-end; material.opacity: 1"
                     event-set__dragon="_event: dragover-start; material.color: #00ff00"
                     event-set__dragoff="_event: dragover-end; material.color: #666">
            </a-mixin>

            <a-mixin id="hand-physics"
                     super-hands="colliderEvent: collisions;
                                  colliderEventProperty: els;
                                  colliderEndEvent: collisions;
                                  colliderEndEventProperty: clearedEls"
                     sphere-collider="objects: [dynamic-body]"
                     hand-tracking-physics>
            </a-mixin>
        </a-assets>

        <!-- Environment -->
        <a-sky color="#222"></a-sky>
        <a-plane position="0 0 0" 
                 rotation="-90 0 0" 
                 width="10" 
                 height="10" 
                 color="#444"
                 static-body
                 grid="width: 10; height: 10">
        </a-plane>

        <!-- Walls for containing objects -->
        <a-box position="0 1 -5" width="10" height="2" depth="0.1" color="#333" static-body></a-box>
        <a-box position="-5 1 0" width="0.1" height="2" depth="10" color="#333" static-body></a-box>
        <a-box position="5 1 0" width="0.1" height="2" depth="10" color="#333" static-body></a-box>

        <!-- Test Components with Different Shapes - Spread out more for better access -->
        <!-- Motherboard (Box shape) -->
        <a-box id="motherboard"
               position="-2 1.2 -1"
               width="0.4"
               height="0.02"
               depth="0.4"
               color="#2a7f2a"
               mixin="cube-physics"
               data-component-type="motherboard"
               physics-shape="shape: box">
            <a-text value="Motherboard" 
                    position="0 0.05 0" 
                    align="center" 
                    scale="0.3 0.3 0.3">
            </a-text>
        </a-box>

        <!-- CPU (Small box) -->
        <a-box id="cpu"
               position="-1 1.2 -1"
               width="0.1"
               height="0.05"
               depth="0.1"
               color="#4169e1"
               mixin="cube-physics"
               data-component-type="cpu"
               physics-shape="shape: box">
            <a-text value="CPU" 
                    position="0 0.05 0" 
                    align="center" 
                    scale="0.2 0.2 0.2">
            </a-text>
        </a-box>

        <!-- GPU (Larger box) -->
        <a-box id="gpu"
               position="0 1.2 -1"
               width="0.3"
               height="0.15"
               depth="0.5"
               color="#ff4500"
               mixin="cube-physics"
               data-component-type="gpu"
               physics-shape="shape: box">
            <a-text value="GPU" 
                    position="0 0.1 0" 
                    align="center" 
                    scale="0.3 0.3 0.3">
            </a-text>
        </a-box>

        <!-- RAM (Thin box) -->
        <a-box id="ram"
               position="1 1.2 -1"
               width="0.3"
               height="0.05"
               depth="0.02"
               color="#32cd32"
               mixin="cube-physics"
               data-component-type="ram"
               physics-shape="shape: box">
            <a-text value="RAM" 
                    position="0 0.05 0" 
                    align="center" 
                    scale="0.2 0.2 0.2">
            </a-text>
        </a-box>

        <!-- PSU (Cube) -->
        <a-box id="psu"
               position="2 1.2 -1"
               width="0.25"
               height="0.25"
               depth="0.25"
               color="#696969"
               mixin="cube-physics"
               data-component-type="psu"
               physics-shape="shape: box">
            <a-text value="PSU" 
                    position="0 0.15 0" 
                    align="center" 
                    scale="0.3 0.3 0.3">
            </a-text>
        </a-box>

        <!-- PC Case (Target) -->
        <a-box id="pc-case"
               position="0 0.5 -3"
               width="0.8"
               height="1"
               depth="0.8"
               color="#1a1a1a"
               opacity="0.7"
               static-body>
            <a-text value="PC CASE" 
                    position="0 0.6 0" 
                    align="center" 
                    scale="0.5 0.5 0.5"
                    color="#fff">
            </a-text>
        </a-box>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="1 3 -0.5" color="#ffffff" intensity="0.5"></a-light>
        <a-light type="point" position="0 2 0" color="#ffffff" intensity="0.5"></a-light>

        <!-- Camera Rig -->
        <a-entity id="rig" position="0 0 0">
            <a-camera id="camera" 
                      position="0 1.6 1" 
                      look-controls 
                      wasd-controls="fly: true">
                <a-cursor raycaster="objects: [mixin='cube-physics']"></a-cursor>
            </a-camera>
            
            <!-- VR Controllers -->
            <a-entity id="leftHand"
                      hand-controls="hand: left"
                      oculus-touch-controls="hand: left"
                      mixin="hand-physics"
                      hand-coordinates="hand: left"
                      smooth-controller>
            </a-entity>
            
            <a-entity id="rightHand"
                      hand-controls="hand: right"
                      oculus-touch-controls="hand: right"
                      oculus-thumbstick-controls="fly: true"
                      mixin="hand-physics"
                      hand-coordinates="hand: right"
                      smooth-controller>
            </a-entity>
        </a-entity>

        <script>
            // Component to track and display hand coordinates
            AFRAME.registerComponent('hand-coordinates', {
                schema: {
                    hand: {type: 'string', default: 'left'}
                },
                
                init: function() {
                    this.coordsDisplay = document.getElementById('hand-coords');
                },
                
                tick: function() {
                    const position = this.el.object3D.position;
                    const coords = `${position.x.toFixed(2)}, y: ${position.y.toFixed(2)}, z: ${position.z.toFixed(2)}`;
                    
                    if (this.coordsDisplay) {
                        const lines = this.coordsDisplay.innerHTML.split('<br>');
                        if (this.data.hand === 'left') {
                            lines[0] = `Left Hand: x: ${coords}`;
                        } else {
                            lines[1] = `Right Hand: x: ${coords}`;
                        }
                        this.coordsDisplay.innerHTML = lines.join('<br>');
                    }
                }
            });

            // Enhanced physics shape component
            AFRAME.registerComponent('physics-shape', {
                schema: {
                    shape: {type: 'string', default: 'auto'}
                },
                
                init: function() {
                    const el = this.el;
                    
                    // Wait for physics to be ready
                    el.addEventListener('body-loaded', () => {
                        // Apply proper physics settings
                        if (el.body) {
                            // Set proper mass distribution
                            el.body.updateMassProperties();
                            
                            // Ensure proper collision detection
                            el.body.setCcdMotionThreshold(0.001);
                            el.body.setCcdSweptSphereRadius(0.01);
                        }
                    });
                    
                    // Debug info on grab
                    el.addEventListener('grab-start', (evt) => {
                        const debugInfo = document.getElementById('physics-debug');
                        const componentType = el.getAttribute('data-component-type') || 'Unknown';
                        debugInfo.innerHTML = `
                            Physics Debug Info:<br>
                            Gravity: -9.8<br>
                            Selected Object: ${componentType}<br>
                            Mass: ${el.body ? el.body.mass.toFixed(2) : 'N/A'}<br>
                            Shape: ${this.data.shape}
                        `;
                    });
                }
            });

            // Hand tracking physics for better collision
            AFRAME.registerComponent('hand-tracking-physics', {
                init: function() {
                    const el = this.el;
                    
                    // Create a physics body for the hand
                    el.addEventListener('loaded', () => {
                        // Add a small sphere collider for the hand
                        const handCollider = document.createElement('a-sphere');
                        handCollider.setAttribute('radius', '0.05');
                        handCollider.setAttribute('visible', 'false');
                        handCollider.setAttribute('static-body', 'shape: sphere');
                        el.appendChild(handCollider);
                    });
                }
            });

            // Better collision detection system
            AFRAME.registerSystem('collision-detection', {
                init: function() {
                    this.collisions = new Map();
                },
                
                registerCollision: function(bodyA, bodyB) {
                    const key = `${bodyA.id}-${bodyB.id}`;
                    this.collisions.set(key, {bodyA, bodyB, time: Date.now()});
                },
                
                tick: function() {
                    // Clean up old collisions
                    const now = Date.now();
                    for (const [key, collision] of this.collisions) {
                        if (now - collision.time > 100) {
                            this.collisions.delete(key);
                        }
                    }
                }
            });

            // Smooth grabbing component
            AFRAME.registerComponent('smooth-grabbing', {
                init: function() {
                    const el = this.el;
                    this.originalDynamicBody = null;
                    this.isGrabbed = false;
                    
                    el.addEventListener('grab-start', (evt) => {
                        this.isGrabbed = true;
                        // Store original physics settings
                        if (el.hasAttribute('dynamic-body')) {
                            this.originalDynamicBody = el.getAttribute('dynamic-body');
                            // Remove physics while grabbed
                            el.removeAttribute('dynamic-body');
                        }
                        
                        // Make object kinematic
                        el.setAttribute('kinematic-body', '');
                    });
                    
                    el.addEventListener('grab-end', (evt) => {
                        this.isGrabbed = false;
                        // Remove kinematic
                        el.removeAttribute('kinematic-body');
                        
                        // Restore physics after a small delay
                        setTimeout(() => {
                            if (this.originalDynamicBody && !this.isGrabbed) {
                                el.setAttribute('dynamic-body', this.originalDynamicBody);
                                
                                // Reset velocities to prevent flying
                                setTimeout(() => {
                                    if (el.body) {
                                        el.body.velocity.set(0, 0, 0);
                                        el.body.angularVelocity.set(0, 0, 0);
                                    }
                                }, 50);
                            }
                        }, 100);
                    });
                }
            });

            // Smooth controller for better grabbing
            AFRAME.registerComponent('smooth-controller', {
                init: function() {
                    // Add visual feedback
                    const el = this.el;
                    const highlight = document.createElement('a-sphere');
                    highlight.setAttribute('radius', '0.03');
                    highlight.setAttribute('color', '#00ff00');
                    highlight.setAttribute('opacity', '0.5');
                    highlight.setAttribute('visible', 'false');
                    el.appendChild(highlight);
                    
                    el.addEventListener('gripdown', () => {
                        highlight.setAttribute('visible', 'true');
                    });
                    
                    el.addEventListener('gripup', () => {
                        highlight.setAttribute('visible', 'false');
                    });
                }
            });

            // Initialize physics world settings
            document.querySelector('a-scene').addEventListener('loaded', () => {
                const sceneEl = document.querySelector('a-scene');
                
                // Apply global physics settings
                if (sceneEl.systems.physics && sceneEl.systems.physics.driver) {
                    const world = sceneEl.systems.physics.driver.world;
                    
                    // Set solver iterations for better stability
                    world.solver.iterations = 10;
                    world.solver.tolerance = 0.001;
                    
                    // Set default contact material
                    world.defaultContactMaterial.friction = 0.4;
                    world.defaultContactMaterial.restitution = 0.3;
                    world.defaultContactMaterial.contactEquationStiffness = 1e8;
                    world.defaultContactMaterial.contactEquationRelaxation = 3;
                    world.defaultContactMaterial.frictionEquationStiffness = 1e8;
                    world.defaultContactMaterial.frictionEquationRelaxation = 3;
                }
                
                console.log('Physics system initialized with improved settings');
            });
        </script>
    </a-scene>

    <div class="info">
        <strong>Fixed Physics Demo</strong><br><br>
        <strong>VR Movement:</strong><br>
        • Right thumbstick - move/fly<br>
        • Left thumbstick - rotate<br>
        • Grip/Trigger - grab objects<br><br>
        <strong>Desktop:</strong><br>
        • WASD - move (Shift to fly up/down)<br>
        • Mouse - look around<br>
        • Click - grab objects<br><br>
        <strong>Improvements:</strong><br>
        • Proper collision shapes<br>
        • Better physics damping<br>
        • Hand coordinate tracking<br>
        • Physics debug info
    </div>
</body>
</html>
