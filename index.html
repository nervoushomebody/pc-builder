<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>VR Збирач ПК - Фінальна версія</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.4/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.1.0/dist/aframe-physics-system.min.js"></script>
    <script src="https://unpkg.com/aframe-physics-extras/dist/aframe-physics-extras.min.js"></script>
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            width: 250px;
            z-index: 10000;
        }
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            z-index: 10000;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s;
        }
        .completion-message {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
    <a-scene physics="gravity: -9.8" locomotion>
        <a-assets>
            <img id="ground" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
            <img id="sky" src="https://cdn.aframe.io/a-painter/images/sky.jpg">
            <a-asset-item id="case-model" src="models/case.glb"></a-asset-item>
            <a-asset-item id="motherboard-model" src="models/motherboard.glb"></a-asset-item>
            <a-asset-item id="cpu-model" src="models/cpu.glb"></a-asset-item>
            <a-asset-item id="ram-model" src="models/ram.glb"></a-asset-item>
            <a-asset-item id="gpu-model" src="models/gpu.glb"></a-asset-item>
            <a-asset-item id="psu-model" src="models/psu.glb"></a-asset-item>
            <a-asset-item id="ssd-model" src="models/ssd.glb"></a-asset-item>
            
            <a-mixin id="interactive"
                     hoverable grabbable draggable respawnable>
            </a-mixin>

            <a-mixin id="physics-hands"
                     physics-collider phase-shift
                     collision-filter="collisionForces: false"
                     static-body="shape: sphere; sphereRadius: 0.02"
                     super-hands="colliderEvent: collisions;
                                  colliderEventProperty: els;
                                  colliderEndEvent: collisions;
                                  colliderEndEventProperty: clearedEls;">
            </a-mixin>
        </a-assets>

        <a-sky src="#sky"></a-sky>
        <a-plane id="ground-plane" src="#ground" rotation="-90 0 0" width="20" height="20" static-body></a-plane>
        
        <!-- Прогрес збірки -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="completion-message" id="completion-message">ПК успішно зібрано!</div>
        
        <!-- Станція збірки -->
        <a-entity id="pc-case-station" position="0 0.8 -1.5">
            <a-box position="0 0.5 0" width="0.6" height="0.1" depth="0.7" color="#4d4d4d" static-body></a-box>
            <a-entity id="pc-case" static-body>
                <a-gltf-model src="#case-model" scale="0.5 0.5 0.5" position="0 0 0"></a-gltf-model>
            </a-entity>
            
            <!-- Слоти для компонентів -->
            <a-entity id="slots">
                <a-entity class="slot" data-accepts="motherboard" position="0 0.1 0" rotation="0 0 0" scale="0.075 0.005 0.0875" visible="false"></a-entity>
                <a-entity class="slot" data-accepts="cpu" position="0.1 0.15 -0.1" rotation="0 0 0" scale="0.02 0.005 0.02" visible="false"></a-entity>
                <a-entity class="slot" data-accepts="ram" position="-0.05 0.15 0.1" rotation="0 0 0" scale="0.03 0.005 0.0075" visible="false"></a-entity>
                <a-entity class="slot" data-accepts="gpu" position="0 0.1 -0.2" rotation="0 0 0" scale="0.0625 0.0075 0.0375" visible="false"></a-entity>
                <a-entity class="slot" data-accepts="psu" position="-0.2 0.1 -0.1" rotation="0 0 0" scale="0.0375 0.02 0.0375" visible="false"></a-entity>
                <a-entity class="slot" data-accepts="ssd" position="0.15 0.1 0.1" rotation="0 0 0" scale="0.025 0.0025 0.0175" visible="false"></a-entity>
            </a-entity>
        </a-entity>

        <!-- Компоненти ПК (зменшені у 4 рази та зсунуті до центру) -->
        <a-entity id="motherboard" mixin="interactive" position="0.4 1.2 0" 
                  dynamic-body="shape: box; boxSize: 0.075 0.005 0.0875"
                  side-description="description: Материнська плата - основа системи.; offset: 0 0.1 -0.25"
                  data-type="motherboard">
            <a-gltf-model src="#motherboard-model" rotation="0 0 0" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>
        
        <a-entity id="cpu" mixin="interactive" position="-0.267 1.2 -0.333" 
                  dynamic-body="shape: box; boxSize: 0.02 0.005 0.02"
                  side-description="description: Процесор (CPU) - мозок комп'ютера.; offset: 0.15 0 0"
                  data-type="cpu">
            <a-gltf-model src="#cpu-model" rotation="0 0 0" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-entity id="ram" mixin="interactive" position="-0.267 1.2 0.267" 
                  dynamic-body="shape: box; boxSize: 0.03 0.005 0.0075"
                  side-description="description: Оперативна пам'ять (RAM).; offset: 0.16 0 0"
                  data-type="ram">
            <a-gltf-model src="#ram-model" rotation="0 0 0" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>
        
        <a-entity id="gpu" mixin="interactive" position="-0.4 1.2 0" 
                  dynamic-body="shape: box; boxSize: 0.0625 0.0075 0.0375"
                  side-description="description: Відеокарта (GPU).; offset: 0 0.05 0.2"
                  data-type="gpu">
            <a-gltf-model src="#gpu-model" rotation="0 0 0" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-entity id="psu" mixin="interactive" position="0.267 1.2 -0.333" 
                  dynamic-body="shape: box; boxSize: 0.0375 0.02 0.0375"
                  side-description="description: Блок живлення (PSU).; offset: 0.18 0.05 0"
                  data-type="psu">
            <a-gltf-model src="#psu-model" rotation="0 0 0" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-entity id="ssd" mixin="interactive" position="0.267 1.2 0.267" 
                  dynamic-body="shape: box; boxSize: 0.025 0.0025 0.0175"
                  side-description="description: SSD накопичувач.; offset: 0.15 0 0"
                  data-type="ssd">
            <a-gltf-model src="#ssd-model" rotation="0 0 0" scale="0.25 0.25 0.25"></a-gltf-model>
        </a-entity>

        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="0 5 0" rotation="-90 0 0" intensity="0.6"></a-light>

        <!-- Система руху з оновленнями -->
        <a-entity id="rig" 
                  movement-controls="speed: 0.3; controls: left" 
                  thumbstick-turn="hand: right"
                  locomotion="teleport: true; type: teleport">
            <a-camera id="camera" position="0 1.6 0" look-controls wasd-controls>
                <a-cursor id="cursor" raycaster="objects: [mixin='interactive']"></a-cursor>
            </a-camera>
            <a-entity id="leftHand" 
                      mixin="physics-hands" 
                      hand-controls="hand: left"
                      laser-controls="hand: left"
                      teleport-controls="teleportOrigin: #camera; button: trigger; type: parabolic">
            </a-entity>
            <a-entity id="rightHand" 
                      mixin="physics-hands" 
                      hand-controls="hand: right"
                      laser-controls="hand: right"
                      teleport-controls="teleportOrigin: #camera; button: trigger; type: parabolic">
            </a-entity>
        </a-entity>

        <script>
            // Покажчик прогресу та повідомлення
            const progressFill = document.getElementById('progress-fill');
            const completionMessage = document.getElementById('completion-message');
            let installedComponents = 0;
            const totalComponents = 6;

            // Компонент для магнітного притягування (оновлена версія)
            AFRAME.registerComponent('magnet-attraction', {
                schema: {
                    hand: {type: 'string', default: 'left'},
                    strength: {type: 'number', default: 8},
                    maxDistance: {type: 'number', default: 2}
                },
                
                init: function () {
                    this.attractedObjects = [];
                    this.raycaster = new THREE.Raycaster();
                    this.direction = new THREE.Vector3();
                    this.triggerPressed = false;
                    
                    // Обробник натискання тригера
                    this.el.addEventListener('triggerdown', () => this.triggerPressed = true);
                    this.el.addEventListener('triggerup', () => {
                        this.triggerPressed = false;
                        this.attractedObjects = [];
                    });
                },
                
                tick: function () {
                    if (!this.triggerPressed) return;
                    
                    // Отримуємо напрямок променя
                    this.el.object3D.getWorldDirection(this.direction);
                    const handPosition = new THREE.Vector3();
                    this.el.object3D.getWorldPosition(handPosition);
                    
                    // Налаштовуємо raycaster
                    this.raycaster.set(handPosition, this.direction.normalize());
                    
                    // Знаходимо всі об'єкти для притягування
                    const interactiveEls = Array.from(document.querySelectorAll('[mixin="interactive"]'));
                    const interactiveObjects = interactiveEls.map(el => el.object3D);
                    
                    // Перевіряємо перетин променя з об'єктами
                    const intersects = this.raycaster.intersectObjects(interactiveObjects, true);
                    
                    if (intersects.length > 0) {
                        const target = intersects[0].object.el;
                        
                        // Перевіряємо, чи об'єкт вже притягується
                        if (!this.attractedObjects.includes(target) && 
                            target.components['dynamic-body'] && 
                            target.object3D.position.distanceTo(handPosition) < this.data.maxDistance) {
                            
                            this.attractedObjects.push(target);
                            
                            // Візуальний ефект
                            target.querySelectorAll('a-gltf-model').forEach(model => {
                                model.setAttribute('material', 'color', '#00ff00');
                            });
                        }
                    }
                    
                    // Притягуємо об'єкти
                    this.attractedObjects.forEach(target => {
                        if (!target || !target.body) return;
                        
                        const targetPos = new THREE.Vector3();
                        target.object3D.getWorldPosition(targetPos);
                        const direction = new THREE.Vector3()
                            .subVectors(handPosition, targetPos)
                            .normalize()
                            .multiplyScalar(this.data.strength);
                        
                        // Застосовуємо силу притягування
                        target.body.velocity.set(
                            direction.x,
                            direction.y,
                            direction.z
                        );
                    });
                }
            });

            // Компонент для збірки ПК
            AFRAME.registerComponent('pc-builder', {
                init: function () {
                    this.installedComponents = new Set();
                    this.slots = Array.from(this.el.querySelectorAll('.slot'));
                    this.tick = AFRAME.utils.throttleTick(this.checkCollisions.bind(this), 100);
                },
                
                checkCollisions: function () {
                    if (this.installedComponents.size >= totalComponents) return;
                    
                    this.slots.forEach(slot => {
                        const slotType = slot.getAttribute('data-accepts');
                        const slotPos = new THREE.Vector3();
                        slot.object3D.getWorldPosition(slotPos);
                        
                        // Шукаємо відповідний компонент
                        const component = document.querySelector(`[data-type="${slotType}"]`);
                        if (!component || this.installedComponents.has(component.id)) return;
                        
                        const componentPos = new THREE.Vector3();
                        component.object3D.getWorldPosition(componentPos);
                        
                        // Перевіряємо відстань
                        const distance = componentPos.distanceTo(slotPos);
                        if (distance < 0.1) {
                            this.installComponent(component, slot);
                        }
                    });
                },
                
                installComponent: function (component, slot) {
                    // Видаляємо фізику
                    component.removeAttribute('dynamic-body');
                    component.setAttribute('static-body', '');
                    
                    // Фіксуємо позицію
                    const slotPos = new THREE.Vector3();
                    slot.object3D.getWorldPosition(slotPos);
                    component.setAttribute('position', slotPos);
                    
                    // Додаємо до встановлених компонентів
                    this.installedComponents.add(component.id);
                    installedComponents = this.installedComponents.size;
                    
                    // Оновлюємо прогрес
                    progressFill.style.width = `${(installedComponents / totalComponents) * 100}%`;
                    
                    // Візуальний ефект
                    component.querySelectorAll('a-gltf-model').forEach(model => {
                        model.setAttribute('material', 'color', '#00ff00');
                    });
                    
                    // Перевіряємо завершення
                    if (installedComponents >= totalComponents) {
                        setTimeout(() => {
                            completionMessage.style.display = 'block';
                        }, 1000);
                    }
                }
            });

            // Показ опису при захопленні
            AFRAME.registerComponent('side-description', {
                schema: {
                    description: {type: 'string', default: 'Item description.'},
                    offset: {type: 'vec3', default: {x: 0.3, y: 0, z: 0}}
                },
                init: function () {
                    const el = this.el;
                    const data = this.data;
                    this.descriptionText = document.createElement('a-text');
                    this.descriptionText.setAttribute('value', data.description);
                    this.descriptionText.setAttribute('align', 'left');
                    this.descriptionText.setAttribute('position', data.offset);
                    this.descriptionText.setAttribute('width', '2');
                    this.descriptionText.setAttribute('look-at', '#camera');
                    this.descriptionText.setAttribute('visible', false);
                    el.appendChild(this.descriptionText);

                    el.addEventListener('grab-start', () => { 
                        this.descriptionText.setAttribute('visible', true); 
                    });
                    el.addEventListener('grab-end', () => { 
                        this.descriptionText.setAttribute('visible', false); 
                    });
                }
            });

            // Респаун об'єктів при падінні
            AFRAME.registerComponent('respawnable', {
                init: function () {
                    this.initialPosition = this.el.object3D.position.clone();
                },
                tick: function () {
                    if (this.el.object3D.position.y < -5 && !this.el.is('grabbed')) {
                        this.resetEntity();
                    }
                },
                resetEntity: function() {
                    const el = this.el;
                    el.object3D.position.copy(this.initialPosition);
                    if (el.body) {
                        el.body.position.copy(this.initialPosition);
                        el.body.velocity.set(0, 0, 0);
                        el.body.angularVelocity.set(0, 0, 0);
                    }
                }
            });

            // Відключення фізики при захопленні
            AFRAME.registerComponent('phase-shift', {
                init: function () {
                    var el = this.el;
                    el.addEventListener('gripdown', () => el.setAttribute('collision-filter', {collisionForces: true}));
                    el.addEventListener('gripup', () => el.setAttribute('collision-filter', {collisionForces: false}));
                }
            });

            // Візуальні ефекти при взаємодії
            AFRAME.registerComponent('hoverable', {
                init: function () {
                    var el = this.el;
                    el.originalColor = el.getAttribute('material') ? el.getAttribute('material').color : '#FFF';
                    el.addEventListener('hover-start', function (evt) { 
                        evt.target.querySelectorAll('a-gltf-model').forEach(model => model.setAttribute('material', 'color', '#ffff00'));
                    });
                    el.addEventListener('hover-end', function (evt) { 
                        if (!el.is('grabbed')) {
                            evt.target.querySelectorAll('a-gltf-model').forEach(model => model.removeAttribute('material'));
                        }
                    });
                    el.addEventListener('grab-start', function (evt) { 
                        evt.target.querySelectorAll('a-gltf-model').forEach(model => model.setAttribute('material', 'color', '#ff0000'));
                    });
                    el.addEventListener('grab-end', function (evt) {
                        if (el.is('hovered')) {
                            evt.target.querySelectorAll('a-gltf-model').forEach(model => model.setAttribute('material', 'color', '#ffff00'));
                        } else {
                            evt.target.querySelectorAll('a-gltf-model').forEach(model => model.removeAttribute('material'));
                        }
                    });
                }
            });

            // Ініціалізація системи збірки
            document.querySelector('a-scene').addEventListener('loaded', () => {
                // Додаємо магнітне притягування до рук
                document.querySelector('#leftHand').setAttribute('magnet-attraction', 'hand: left');
                document.querySelector('#rightHand').setAttribute('magnet-attraction', 'hand: right');
                
                // Ініціалізуємо систему збірки
                document.querySelector('#pc-case-station').setAttribute('pc-builder', '');
            });
        </script>
    </a-scene>

    <div class="info">
        <strong>Керування:</strong><br>
        Корпус ПК перед вами. Компоненти розташовані навколо вас.<br><br>
        <strong>VR:</strong><br>
         - <strong>Взяти:</strong> Простягніть руку і натисніть Тригер/Grip.<br>
         - <strong>Рух:</strong> Лівий джойстик для плавного пересування.<br>
         - <strong>Телепортація:</strong> Натисніть тригер на лазерному контролері.<br>
         - <strong>Притягування:</strong> Натисніть тригер на вільній руці у бік предмета.<br>
         - <strong>Поворот:</strong> Правий джойстик.<br>
         - <strong>Інфо:</strong> При захопленні предмета збоку з'явиться опис.<br><br>
        <strong>Desktop:</strong> WASD для руху, миша для огляду.
        <br><br>
        <strong>Мета:</strong> Зібрати ПК, перетягуючи компоненти в корпус!
    </div>
</body>
</html>
