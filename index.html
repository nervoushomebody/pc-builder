<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>VR PC Builder</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/super-hands@3.0.4/dist/super-hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@^4.1.1/dist/aframe-event-set-component.min.js"></script>
    <script src="https://gftruj.github.io/webzamples/aframe/controls/oculus-thumbstick-controls.js"></script>
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        .info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            width: 250px;
            z-index: 10000;
        }
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            z-index: 10000;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s;
        }
        .completion-message {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 24px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
    <a-scene>
        <a-assets>
            <img id="ground" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
            <img id="sky" src="https://cdn.aframe.io/a-painter/images/sky.jpg">
            <a-asset-item id="case-model" src="models/case.glb"></a-asset-item>
            <a-asset-item id="motherboard-model" src="models/motherboard.glb"></a-asset-item>
            <a-asset-item id="cpu-model" src="models/cpu.glb"></a-asset-item>
            <a-asset-item id="ram-model" src="models/ram.glb"></a-asset-item>
            <a-asset-item id="gpu-model" src="models/gpu.glb"></a-asset-item>
            <a-asset-item id="psu-model" src="models/psu.glb"></a-asset-item>
            <a-asset-item id="ssd-model" src="models/ssd.glb"></a-asset-item>
            
            <a-mixin id="interactive"
                     hoverable grabbable draggable respawnable>
            </a-mixin>

            <a-mixin id="grab-hands"
                     super-hands="colliderEvent: raycaster-intersection;
                                  colliderEventProperty: els;
                                  colliderEndEvent: raycaster-intersection-cleared;
                                  colliderEndEventProperty: clearedEls;">
            </a-mixin>
        </a-assets>

        <a-sky src="#sky"></a-sky>
        <a-plane id="ground-plane" src="#ground" rotation="-90 0 0" width="20" height="20"></a-plane>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <div class="completion-message" id="completion-message">PC successfully assembled!</div>
        
        <a-entity id="pc-case-station" position="0 0.8 -1.5" pc-builder>
            <!-- Base platform -->
            <a-box position="0 0.05 0" width="0.6" height="0.01" depth="0.7" color="#4d4d4d"></a-box>
            
            <!-- PC Case -->
            <a-entity id="pc-case">
                <a-box position="0 0.15 0" width="0.4" height="0.3" depth="0.5" color="#333333" opacity="0.8"></a-box>
            </a-entity>
            
            <!-- Components scattered around the case -->
            <a-entity id="components-container">
                <!-- Motherboard -->
                <a-entity id="motherboard" class="component" data-type="motherboard" 
                          position="-0.8 0.15 0.2" rotation="0 45 0" scale="0.3 0.3 0.3"
                          original-position="-0.05 0.2 0"
                          side-description="description: Motherboard - main system board; offset: 0 0.1 0">
                    <a-box width="0.4" height="0.02" depth="0.3" color="#006600"></a-box>
                </a-entity>
                
                <!-- CPU -->
                <a-entity id="cpu" class="component" data-type="cpu" 
                          position="0.6 0.15 -0.3" rotation="0 -30 0" scale="0.3 0.3 0.3"
                          original-position="0 0.22 0"
                          side-description="description: CPU - computer's brain; offset: 0 0.1 0">
                    <a-box width="0.15" height="0.05" depth="0.15" color="#silver"></a-box>
                </a-entity>
                
                <!-- RAM -->
                <a-entity id="ram" class="component" data-type="ram" 
                          position="-0.5 0.15 -0.6" rotation="0 90 0" scale="0.3 0.3 0.3"
                          original-position="0.1 0.24 0"
                          side-description="description: RAM - temporary memory; offset: 0 0.1 0">
                    <a-box width="0.03" height="0.3" depth="0.4" color="#darkgreen"></a-box>
                </a-entity>
                
                <!-- GPU -->
                <a-entity id="gpu" class="component" data-type="gpu" 
                          position="0.8 0.15 0.4" rotation="0 -45 0" scale="0.3 0.3 0.3"
                          original-position="-0.1 0.18 0.1"
                          side-description="description: GPU - graphics processing; offset: 0 0.1 0">
                    <a-box width="0.6" height="0.1" depth="0.25" color="#red"></a-box>
                </a-entity>
                
                <!-- PSU -->
                <a-entity id="psu" class="component" data-type="psu" 
                          position="0.3 0.15 0.7" rotation="0 180 0" scale="0.3 0.3 0.3"
                          original-position="0.1 0.08 -0.15"
                          side-description="description: PSU - power supply; offset: 0 0.1 0">
                    <a-box width="0.4" height="0.2" depth="0.35" color="#black"></a-box>
                </a-entity>
                
                <!-- SSD -->
                <a-entity id="ssd" class="component" data-type="ssd" 
                          position="-0.7 0.15 -0.2" rotation="0 60 0" scale="0.3 0.3 0.3"
                          original-position="0.15 0.12 -0.1"
                          side-description="description: SSD - storage; offset: 0 0.1 0">
                    <a-box width="0.25" height="0.02" depth="0.18" color="#blue"></a-box>
                </a-entity>
            </a-entity>
            
            <!-- Light inside the case -->
            <a-light type="point" color="#ffffff" intensity="0.7" position="0 0.3 0"></a-light>
        </a-entity>

        <!-- Lighting -->
        <a-light type="ambient" color="#505050" intensity="0.6"></a-light>
        <a-light type="directional" position="0 5 0" rotation="-90 0 0" intensity="0.8"></a-light>
        <a-light type="directional" position="0 3 3" rotation="-60 0 0" intensity="0.5"></a-light>
        <a-light type="point" color="#ffffff" intensity="0.6" position="0 2 0"></a-light>

        <a-entity id="rig">
            <a-camera id="camera" position="0 1.6 0" look-controls wasd-controls="fly: true">
                <a-cursor id="cursor" raycaster="objects: [mixin='interactive']"></a-cursor>
            </a-camera>
            <a-entity id="leftHand" 
                      mixin="grab-hands" 
                      hand-controls="hand: left"
                      laser-controls="hand: left"
                      teleport-controls="teleportOrigin: #camera; button: trigger; type: parabolic"
                      oculus-thumbstick-controls="fly: true"
                      raycaster="objects: [mixin='interactive']; showLine: true">
            </a-entity>
            <a-entity id="rightHand" 
                      mixin="grab-hands" 
                      hand-controls="hand: right"
                      laser-controls="hand: right"
                      teleport-controls="teleportOrigin: #camera; button: trigger; type: parabolic"
                      raycaster="objects: [mixin='interactive']; showLine: true">
            </a-entity>
        </a-entity>

        <script>
            // Progress tracking
            const progressFill = document.getElementById('progress-fill');
            const completionMessage = document.getElementById('completion-message');
            let installedComponents = 0;
            const totalComponents = 6;

            // Make components interactive
            document.querySelector('a-scene').addEventListener('loaded', function() {
                const components = document.querySelectorAll('.component');
                components.forEach(comp => {
                    comp.setAttribute('mixin', 'interactive');
                });
            });

            // PC Builder component
            AFRAME.registerComponent('pc-builder', {
                init: function () {
                    this.installedComponents = new Set();
                    this.el.sceneEl.addEventListener('component-installed', this.updateProgress.bind(this));
                    
                    // Set up checking
                    this.tick = AFRAME.utils.throttleTick(this.checkComponents, 100, this);
                },

                checkComponents: function() {
                    const components = document.querySelectorAll('.component:not(.installed)');
                    
                    components.forEach(comp => {
                        if (comp.is('grabbed')) return;
                        
                        // Get original position from attribute
                        const originalPos = AFRAME.utils.coordinates.parse(comp.getAttribute('original-position'));
                        const currentPos = comp.object3D.position;
                        const casePos = this.el.object3D.position;
                        
                        // Calculate world position of where component should be
                        const targetWorldPos = new THREE.Vector3(
                            casePos.x + originalPos.x,
                            casePos.y + originalPos.y,
                            casePos.z + originalPos.z
                        );
                        
                        const currentWorldPos = new THREE.Vector3();
                        comp.object3D.getWorldPosition(currentWorldPos);
                        
                        if (currentWorldPos.distanceTo(targetWorldPos) < 0.15) {
                            this.installComponent(comp);
                        }
                    });
                },
                
                installComponent: function(component) {
                    component.classList.add('installed');
                    
                    // Move to correct position
                    const originalPos = AFRAME.utils.coordinates.parse(component.getAttribute('original-position'));
                    component.setAttribute('position', originalPos);
                    component.setAttribute('rotation', '0 0 0');
                    
                    // Add green glow to indicate installed
                    component.setAttribute('animation', 'property: scale; to: 1.1 1.1 1.1; dur: 200; dir: alternate; loop: 2');
                    
                    this.installedComponents.add(component.id);
                    this.el.sceneEl.emit('component-installed');
                },

                updateProgress: function() {
                    installedComponents = this.installedComponents.size;
                    progressFill.style.width = `${(installedComponents / totalComponents) * 100}%`;

                    if (installedComponents >= totalComponents) {
                        setTimeout(() => {
                            completionMessage.style.display = 'block';
                        }, 1000);
                    }
                }
            });

            // Component description display
            AFRAME.registerComponent('side-description', {
                schema: {
                    description: {type: 'string'},
                    offset: {type: 'vec3'}
                },
                init: function() {
                    this.descriptionText = document.createElement('a-text');
                    this.descriptionText.setAttribute('value', this.data.description);
                    this.descriptionText.setAttribute('align', 'left');
                    this.descriptionText.setAttribute('position', this.data.offset);
                    this.descriptionText.setAttribute('width', '2');
                    this.descriptionText.setAttribute('look-at', '#camera');
                    this.descriptionText.setAttribute('visible', 'false');
                    this.el.appendChild(this.descriptionText);

                    this.el.addEventListener('grab-start', () => {
                        this.descriptionText.setAttribute('visible', 'true');
                    });
                    this.el.addEventListener('grab-end', () => {
                        this.descriptionText.setAttribute('visible', 'false');
                    });
                }
            });

            // Respawn components if they fall
            AFRAME.registerComponent('respawnable', {
                init: function() {
                    this.originalPosition = AFRAME.utils.coordinates.parse(this.el.getAttribute('position'));
                    this.originalRotation = AFRAME.utils.coordinates.parse(this.el.getAttribute('rotation'));
                },
                tick: function() {
                    if (this.el.object3D.position.y < -2 && !this.el.is('grabbed')) {
                        this.resetEntity();
                    }
                },
                resetEntity: function() {
                    this.el.setAttribute('position', this.originalPosition);
                    this.el.setAttribute('rotation', this.originalRotation);
                }
            });
            
            // Hover effects
            AFRAME.registerComponent('hoverable', {
                init: function() {
                    this.originalColor = null;
                    
                    this.el.addEventListener('hover-start', (evt) => {
                        const boxes = evt.target.querySelectorAll('a-box');
                        boxes.forEach(box => {
                            if (!this.originalColor) {
                                this.originalColor = box.getAttribute('color');
                            }
                            box.setAttribute('color', '#ffff00');
                        });
                    });
                    
                    this.el.addEventListener('hover-end', (evt) => {
                        if (!this.el.is('grabbed') && this.originalColor) {
                            const boxes = evt.target.querySelectorAll('a-box');
                            boxes.forEach(box => {
                                box.setAttribute('color', this.originalColor);
                            });
                        }
                    });
                    
                    this.el.addEventListener('grab-start', (evt) => {
                        const boxes = evt.target.querySelectorAll('a-box');
                        boxes.forEach(box => {
                            box.setAttribute('color', '#ff0000');
                        });
                    });
                    
                    this.el.addEventListener('grab-end', (evt) => {
                        if (this.originalColor) {
                            const boxes = evt.target.querySelectorAll('a-box');
                            boxes.forEach(box => {
                                box.setAttribute('color', this.originalColor);
                            });
                        }
                    });
                }
            });

            // Custom draggable component without physics
            AFRAME.registerComponent('draggable', {
                init: function() {
                    this.grabbed = false;
                    this.hand = null;
                    this.offset = new THREE.Vector3();
                    
                    this.el.addEventListener('grab-start', (evt) => {
                        this.grabbed = true;
                        this.hand = evt.detail.hand;
                        
                        // Calculate offset
                        const handPos = new THREE.Vector3();
                        const objPos = new THREE.Vector3();
                        this.hand.object3D.getWorldPosition(handPos);
                        this.el.object3D.getWorldPosition(objPos);
                        this.offset.subVectors(objPos, handPos);
                    });
                    
                    this.el.addEventListener('grab-end', (evt) => {
                        this.grabbed = false;
                        this.hand = null;
                    });
                },
                
                tick: function() {
                    if (this.grabbed && this.hand) {
                        const handPos = new THREE.Vector3();
                        this.hand.object3D.getWorldPosition(handPos);
                        handPos.add(this.offset);
                        this.el.object3D.position.copy(handPos);
                    }
                }
            });
        </script>
    </a-scene>

    <div class="info">
        <strong>Controls:</strong><br>
        PC components are scattered around. Pick them up and place them in the case!<br><br>
        <strong>VR:</strong><br>
         - <strong>Grab:</strong> Point at component and press Trigger/Grip.<br>
         - <strong>Fly/Move:</strong> Left thumbstick for smooth movement.<br>
         - <strong>Teleport:</strong> Press trigger on laser controller.<br>
         - <strong>Rotate:</strong> Right thumbstick.<br>
         - <strong>Info:</strong> Description appears when holding component.<br><br>
        <strong>Desktop:</strong> WASD to move, mouse to look, click to grab.
        <br><br>
        <strong>Goal:</strong> Install all 6 PC components in the case!
    </div>
</body>
</html>
